<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public/controller/Controller.js - Muliplayer Tetris</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Muliplayer Tetris"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/controller.Auswahl.html">controller.Auswahl</a></li>
            
                <li><a href="../classes/controller.Chat.html">controller.Chat</a></li>
            
                <li><a href="../classes/controller.Controller.html">controller.Controller</a></li>
            
                <li><a href="../classes/display.AfterGame.html">display.AfterGame</a></li>
            
                <li><a href="../classes/display.Display.html">display.Display</a></li>
            
                <li><a href="../classes/display.Lounge.html">display.Lounge</a></li>
            
                <li><a href="../classes/display.MyAudio.html">display.MyAudio</a></li>
            
                <li><a href="../classes/display.Spieler.html">display.Spieler</a></li>
            
                <li><a href="../classes/global.API_SCHEMA.html">global.API_SCHEMA</a></li>
            
                <li><a href="../classes/global.BUTTON.html">global.BUTTON</a></li>
            
                <li><a href="../classes/global.BUTTONTYPE.html">global.BUTTONTYPE</a></li>
            
                <li><a href="../classes/global.CONFIG.html">global.CONFIG</a></li>
            
                <li><a href="../classes/global.GAME_EVENT.html">global.GAME_EVENT</a></li>
            
                <li><a href="../classes/global.LIST_EVENT.html">global.LIST_EVENT</a></li>
            
                <li><a href="../classes/global.pre_defs.html">global.pre_defs</a></li>
            
                <li><a href="../classes/global.Util.html">global.Util</a></li>
            
                <li><a href="../classes/server.Api.html">server.Api</a></li>
            
                <li><a href="../classes/server.Chat.html">server.Chat</a></li>
            
                <li><a href="../classes/server.CommandLine.html">server.CommandLine</a></li>
            
                <li><a href="../classes/server.Controller.html">server.Controller</a></li>
            
                <li><a href="../classes/server.Database.html">server.Database</a></li>
            
                <li><a href="../classes/server.Display.html">server.Display</a></li>
            
                <li><a href="../classes/server.Game.html">server.Game</a></li>
            
                <li><a href="../classes/server.games.AbstractGame.html">server.games.AbstractGame</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.html">server.games.SpielAufZeit</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Block.html">server.games.SpielAufZeit.Block</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Blockelement.html">server.games.SpielAufZeit.Blockelement</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Spieler.html">server.games.SpielAufZeit.Spieler</a></li>
            
                <li><a href="../classes/server.Main.html">server.Main</a></li>
            
                <li><a href="../classes/server.Profil.html">server.Profil</a></li>
            
                <li><a href="../classes/server.Router.html">server.Router</a></li>
            
                <li><a href="../classes/server.RouterChache.html">server.RouterChache</a></li>
            
                <li><a href="../classes/server.Server.html">server.Server</a></li>
            
                <li><a href="../classes/server.SpielTyp.html">server.SpielTyp</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/controller.html">controller</a></li>
            
                <li><a href="../modules/display.html">display</a></li>
            
                <li><a href="../modules/global.html">global</a></li>
            
                <li><a href="../modules/server.html">server</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public/controller/Controller.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * Konsturktor für Controller
 *
 * @module controller
 * @namespace controller
 * @class Controller
 * @param {String} serverAdress
 * @constructor
 */
function Controller(serverAdress){

	/**
	 * @property _elesMap
	 * @type Map
	 * @private
	 */
	this._elesMap = [
		[&quot;#rotateLeft&quot;,  BUTTON.RotateLeft],
		[&quot;#item1&quot;,       BUTTON.Item1],
		[&quot;#item2&quot;,       BUTTON.Item2],
		[&quot;#item3&quot;,       BUTTON.Item3],
		[&quot;#rotateRight&quot;, BUTTON.RotateRight],
		[&quot;#exit&quot;,        BUTTON.Exit],
		[&quot;#left&quot;,        BUTTON.Left],
		[&quot;#down&quot;,        BUTTON.Down],
		[&quot;#right&quot;,       BUTTON.Right]
	];
	
	/**
	 * @property _keyMap
	 * @type Map
	 * @private
	 */
	this._keyMap = [
		[&quot;#rotateLeft&quot;,  CONFIG.KEYS.RotateLeft],
		[&quot;#item1&quot;,       CONFIG.KEYS.Item1],
		[&quot;#item2&quot;,       CONFIG.KEYS.Item2],
		[&quot;#item3&quot;,       CONFIG.KEYS.Item3],
		[&quot;#rotateRight&quot;, CONFIG.KEYS.RotateRight],
		[&quot;#exit&quot;,        CONFIG.KEYS.Exit],
		[&quot;#left&quot;,        CONFIG.KEYS.Left],
		[&quot;#down&quot;,        CONFIG.KEYS.Down],
		[&quot;#right&quot;,       CONFIG.KEYS.Right]
	];
	
	/**
	 * @property _socket
	 * @type Socket
	 * @default null
	 * @private
	 */
	this._socket = null;
	
	/**
	 * @property _touch_deactivated
	 * @type Boolean
	 * @default false
	 * @private
	 */
	this._touch_deactivated = false;
	
	/**
	 * @property _id
	 * @type Number
	 * @default null
	 * @private
	 */
	this._id = null;
	
	/**
	 * @property _game_selected
	 * @type Number
	 * @default null
	 * @private
	 */
	this._game_selected = null;
	
	/**
	 * @property _serverAdress
	 * @type String
	 * @private
	 */
	this._serverAdress = serverAdress;
	
	/**
	 * @property _buttonsDown
	 * @type Array
	 * @default []
	 * @private
	 */
	this._buttonsDown = [];
	
	/**
	 * @property _profil_id
	 * @type Number
	 * @default null
	 * @private
	 */
	this._profil_id = null;
	
	/**
	 * @property _profil
	 * @type String
	 * @default null
	 * @private
	 */
	this._profil = null;
	
	/**
	 * @property _active
	 * @type Boolean
	 * @default true
	 * @private
	 */
	this._active = true;
	
	/**
	 * @property _connectionLost
	 * @type Boolean
	 * @default false
	 * @private
	 */
	this._connectionLost = false;
	
	/**
	 * @property _color
	 * @type Array
	 * @default [255,255,255]
	 * @private
	 */
	this._color = [255,255,255];
	
	
	/**
	 * @property _auswahl
	 * @type controller.Auswahl
	 * @default null
	 * @private
	 */
	this._auswahl = null;
	
	/**
	 * @property _isTouch
	 * @type Boolean
	 * @private
	 */
	this._isTouch = !!(&#x27;ontouchstart&#x27; in window);
	
	/**
	 * @property _catchKeyboard
	 * @type Boolean
	 * @private
	 */
	this._catchKeyboard = false;
}

/**
 * @method init
 * @param {controller.Auswahl} auswahl
 * @param {Function} callback
 * @async
 */
Controller.prototype.init = function(auswahl, callback){
	this._auswahl = auswahl;
	
	
	document.body.addEventListener(&#x27;touchmove&#x27;, function(event) {
		if(this._touch_deactivated){
			event.preventDefault();
		}
	}, false);
	

	$(window).on(&quot;resize&quot;, function(){
		this._resize();
	}.bind(this));
	
	this._initSocket(callback);
	this._initListeners();
};

/**
 * @method init
 * @param {Function} callback
 * @async
 * @private
 */
Controller.prototype._initSocket = function(callback){
	// start connection
	this._socket = io.connect(this._serverAdress);
	
	this._socket.on(&#x27;connect&#x27;, function () {
	
		if(this._connectionLost){
			this._reconnected();
			return;
		}
		
		this.connectControllerToServer(callback);
		this._bindSocketEvents();
		
	}.bind(this)); 
	
	this._socket.on(&#x27;disconnect&#x27;, function () {
		this.connectionLost();
	}.bind(this)); 
};

/**
 * @method connectControllerToServer
 * @param {Function} callback
 * @async
 */
Controller.prototype.connectControllerToServer = function(callback){
	// Controller verbindet sich 
	this._socket.emit(&#x27;connectController&#x27;, {}, function (data) {
		this._id = data.id;
		
		this._bindSocketEvents();
		callback(data);
	}.bind(this));
};

/**
 * @method _bindSocketEvents
 * @private
 */
Controller.prototype._bindSocketEvents = function(){
	this._socket.on(&#x27;SpielCountdown&#x27;, function (data) {
		this.show(data);
	}.bind(this));
	
	this._socket.on(GAME_EVENT.START, function (data) {
		var i;
		for(i in data.details.spieler){
			if(data.details.spieler[i].id == this.getProfilId()){
				this.setColor(data.details.spieler[i].color);
				break;
			}
		}
		this.setActive(true);
		$(&quot;#profil_infos&quot;).html(&quot;P.ID: &quot;+this._profil.id+&quot;, &quot;+this._profil.name+&quot;&quot;);
		$(&quot;#spiel_infos&quot;).html(&quot;S.ID: &quot;+data.SpielID);
		this.show();
	}.bind(this));
	
	this._socket.on(GAME_EVENT.PUNKTE, function (data, fn) {
		//console.log(&quot;SpielPunkte:&quot; + data);
	}.bind(this));
	
	this._socket.on(GAME_EVENT.NEXT_BLOCK, function (data, fn) {
		//console.log(&quot;SpielNextBlock:&quot; + data);
	}.bind(this));
	
	this._socket.on(GAME_EVENT.SPIELER_AUSGESCHIEDEN, function (data, fn) {
		this.setActive(false);
	}.bind(this));
	
	this._socket.on(GAME_EVENT.ENDE, function (data) {
		this.setActive(false);
	}.bind(this));
};

/**
 * @method _initListeners
 * @private
 */
Controller.prototype._initListeners = function(){
	var e, that = this;
	if(this._isTouch){
		// Bedienung per Touch
		for(e in this._elesMap){
			$(&quot;#controller&quot;).delegate(this._elesMap[e][0], &quot;touchstart&quot;, function(id){
				var t = that._elesMap[e][1];
				return function(){
					that.buttonDown(t);
					event.preventDefault();	
				}.bind(this);
			}.bind(this)(this._elesMap[e][0]));
			
			$(&quot;#controller&quot;).delegate(this._elesMap[e][0], &quot;touchend&quot;, function(id){
				var t = that._elesMap[e][1];
				return function(){
					that.buttonUp(t);
					event.preventDefault();	
				}.bind(this);
			}.bind(this)(this._elesMap[e][0]));
		}
	}else{  
		// mit der Maus spielbar machen
		for(e in this._elesMap){
			$(this._elesMap[e][0]).data(&quot;map_index&quot;, e);
			
			$(&quot;#controller&quot;).delegate(this._elesMap[e][0], &quot;mousedown&quot;, function(event){
				var index = $(this).data(&quot;map_index&quot;);
				that.buttonDown(that._elesMap[index][1]);
				event.preventDefault();		
			}); 
			$(&quot;#controller&quot;).delegate(this._elesMap[e][0], &quot;mouseup&quot;, function(event){
				var index = $(this).data(&quot;map_index&quot;);
				that.buttonUp(that._elesMap[index][1]);
				event.preventDefault();					
			});
		}
	}
	
	
	// auch per Tastatur (wer spiel schon mit Maus) ;)
	$(&quot;body&quot;).keydown(function(event) {	
		if(!that._catchKeyboard) return;
		var i;
		for(i in that._keyMap){
			if(event.which === that._keyMap[i][1]){
				$(that._keyMap[i][0]).mousedown();
				event.preventDefault();						
			}
		}
	});
	
	$(&quot;body&quot;).keyup(function(event) {
		if(!that._catchKeyboard) return;
		var i;
		for(i in that._keyMap){
			if(event.which === that._keyMap[i][1]){
				$(that._keyMap[i][0]).mouseup();
				event.preventDefault();						
			}
		}
	});
};

/**
  * @method deselectSpiel
  */
Controller.prototype.deselectSpiel = function(){
	if(this._game_selected !== null){
		
		$(&quot;#game_&quot;+this._game_selected+&quot;.element&quot;).addClass(&quot;button&quot;);
		this._game_selected = null;
	}
};

/**
  * @method disselectProfil
  * @param {Function} [callback]
  * @async
  */
Controller.prototype.disselectProfil = function(callback){
	this._socket.emit(&#x27;disselectPlayer&#x27;, {}, function (result) {
		this.setProfil(null);
		this.setProfilId(null);
		document.title = &quot;Controller&quot;;
		if(callback) callback(result);
	}.bind(this));
};

/**
  * @method selectProfil
  *
  * @param {Number} profilId
  * @param {Function} [callback]
  * @async
  */
Controller.prototype.selectProfil = function(profilId, callback){
	this._socket.emit(&#x27;selectPlayer&#x27;, {profil_id: profilId}, function (result) {
		if(result.ok === true){
			this.setProfilId(profilId);
			this.setProfil(result.data);
			document.title = result.data.name+&quot; | Controller&quot;;
			if(callback) callback(result);
		}else{
			console.log(&quot;ERRRRRROR&quot;);
		}
	}.bind(this));
};

/**
  * @method selectGame
  *
  * @param {Number} spielId
  * @param {Function} [callback]
  * @async
  */
Controller.prototype.selectGame = function(spielId, callback){
	this._socket.emit(&#x27;selectGame&#x27;, {SpielID: spielId}, function (result) {
		if(callback) callback(result);	
	}.bind(this));
};

/**
  * @method leaveGame
  *
  * @param {Number} spielId
  * @param {Function} [callback]
  * @async
  */
Controller.prototype.leaveGame = function(spielId, callback){
	this._socket.emit(&#x27;leaveGame&#x27;, {}, function (result) {
		if(callback) callback(result);
	}.bind(this));
};

/**
  * @method startGame
  *
  * @param {Number} spiel_id
  * @param {Function} [callback]
  * @async
  */
Controller.prototype.startGame = function(spiel_id, callback){
	this._socket.emit(&#x27;startGame&#x27;, {SpielID: spiel_id}, function (result) {
		callback(result);
	}.bind(this));
};

/**
  * @method setColor
  *
  * @param {Array} color
  */
Controller.prototype.setColor = function(color){
	this._color = color;
	$(&quot;#controller .playerColor span&quot;).css({&quot;background&quot;:&quot;rgba(&quot;+color[0]+&quot;,&quot;+color[1]+&quot;,&quot;+color[2]+&quot;,1)&quot;});
	
};

/**
  * @method getProfilId
  *
  * @return {Number}
  */
Controller.prototype.getProfilId = function(){
	return this._profil_id;
};

/**
  * @method getProfil
  *
  * @return {JSON}
  */
Controller.prototype.getProfil = function(){
	return this._profil;
};

/**
  * @method setProfilId
  *
  * @param {Number} id
  */
Controller.prototype.setProfilId = function(id){
	this._profil_id = id;
};

/**
  * @method setProfil
  *
  * @param {String} profil
  */
Controller.prototype.setProfil = function(profil){
	this._profil = profil;
};

/**
  * @method getGameSelected
  *
  * @return {Number}
  */
Controller.prototype.getGameSelected = function(){
	return this._game_selected;
};

/**
  * Gibt die (server-interne) id des Controllers wieder.
  *
  * @method getId
  *
  * @return {Number} die Controller-ID
  */
Controller.prototype.getId = function(){
	return this._id;
};

/**
  * @method isActive
  *
  * @return {Boolean}
  */
Controller.prototype.isActive = function(){
	return this._active;
};

/**
  * @method setActive
  *
  * @param {Boolean} b
  */
Controller.prototype.setActive = function(b){
	this._active = b;
	
	if(this._active === false){
		$(&quot;#controller button&quot;).prop(&#x27;disabled&#x27;, true);
		$(&quot;#controller button#exit&quot;).prop(&#x27;disabled&#x27;, false);
	}else{
		$(&quot;#controller button&quot;).prop(&#x27;disabled&#x27;, false);
	}
};

/**
  * @method getSocket
  *
  * @return {Socket}
  */
Controller.prototype.getSocket = function(){
	return this._socket;
};	

/**
  * @method _reconnected
  * @private
  */
Controller.prototype._reconnected = function(){	
	$(&quot;#connection_lost&quot;).html(&quot;Connection found. Reload in &lt;span&gt;&quot;+CONFIG.reconnectReloadTime+&quot;&lt;/span&gt;ms...&quot;);
	setTimeout(&quot;window.location.href=window.location.href;&quot;, CONFIG.reconnectReloadTime);
	$(&quot;#connection_lost span&quot;).prop(&#x27;number&#x27;, CONFIG.reconnectReloadTime);
	$(&quot;#connection_lost span&quot;).animateNumber({ number: 0, easing: &#x27;linear&#x27; }, CONFIG.reconnectReloadTime);
};


/**
  * @method connectionLost
  */
Controller.prototype.connectionLost = function(){
	$(&quot;#connection_lost&quot;).html(&quot;Connection Lost.. trying to reconnect..&quot;);
	$(&quot;#connection_lost&quot;).show();
	this._connectionLost = true;
};

/**
  * @method _resize
  * @private
  */
Controller.prototype._resize = function(){
	var size = $(&quot;#profil_infos&quot;).height();
	$(&quot;#profil_infos, #spiel_infos, #exit&quot;).css(&quot;font-size&quot;,(size-20)+&quot;px&quot;);
	$(&quot;#profil_infos, #spiel_infos, #exit&quot;).css(&quot;line-height&quot;,size+&quot;px&quot;);
};

/**
  * @method buttonDown
  *
  * @param {global.BUTTON} button
  */
Controller.prototype.buttonDown = function(button){
	if(button === BUTTON.Exit){
		return;
	}

	if(!Util.inArray(this._buttonsDown, button)){
		this._buttonsDown.unshift(button);
		this._socket.emit(&#x27;button&#x27;, {&quot;type&quot;: BUTTONTYPE.Down, &quot;key&quot;: button});
	}
};

/**
  * @method buttonUp
  *
  * @param {global.BUTTON} button
  */
Controller.prototype.buttonUp = function(button){
	if(button === BUTTON.Exit){
		this.leaveGame();
		this._auswahl.showLevelauswahl();
		this._auswahl.flash();
		return;
	}
	
	this._buttonsDown = Util.delArray(this._buttonsDown, button);
	this._socket.emit(&#x27;button&#x27;, {&quot;type&quot;: BUTTONTYPE.Up, &quot;key&quot;: button});
};

/**
  * @method show
  *
  * @param {Number} time
  */
Controller.prototype.show = function(time){
	this._auswahl.hide();
	$(&quot;#controller&quot;).show();
	
	this._touch_deactivated = true;
	this._catchKeyboard = true;
	
	if(time !== undefined){
		$(&quot;#countdown&quot;).css(&quot;opacity&quot;,1);
		$(&quot;#countdown span&quot;).prop(&#x27;number&#x27;, time)
		$(&quot;#countdown span&quot;).animateNumber({ number: 0, easing: &#x27;linear&#x27; }, time, function(){
			$(&quot;#countdown&quot;).stop().animate({&quot;opacity&quot;:0}, 250);
			$(&quot;#countdown&quot;).hide();
		});
		$(&quot;#countdown&quot;).show();
	}
	
	this._resize();
};

/**
  * @method hide
  */
Controller.prototype.hide = function(){
	$(&quot;#controller&quot;).hide();
	this._touch_deactivated = false;
	this._catchKeyboard = false;
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
