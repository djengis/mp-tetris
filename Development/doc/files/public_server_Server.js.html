<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>public/server/Server.js - Muliplayer Tetris</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="Muliplayer Tetris"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/controller.Auswahl.html">controller.Auswahl</a></li>
            
                <li><a href="../classes/controller.Chat.html">controller.Chat</a></li>
            
                <li><a href="../classes/controller.Controller.html">controller.Controller</a></li>
            
                <li><a href="../classes/display.AfterGame.html">display.AfterGame</a></li>
            
                <li><a href="../classes/display.Display.html">display.Display</a></li>
            
                <li><a href="../classes/display.Lounge.html">display.Lounge</a></li>
            
                <li><a href="../classes/display.MyAudio.html">display.MyAudio</a></li>
            
                <li><a href="../classes/display.Spieler.html">display.Spieler</a></li>
            
                <li><a href="../classes/global.API_SCHEMA.html">global.API_SCHEMA</a></li>
            
                <li><a href="../classes/global.BUTTON.html">global.BUTTON</a></li>
            
                <li><a href="../classes/global.BUTTONTYPE.html">global.BUTTONTYPE</a></li>
            
                <li><a href="../classes/global.CONFIG.html">global.CONFIG</a></li>
            
                <li><a href="../classes/global.GAME_EVENT.html">global.GAME_EVENT</a></li>
            
                <li><a href="../classes/global.LIST_EVENT.html">global.LIST_EVENT</a></li>
            
                <li><a href="../classes/global.pre_defs.html">global.pre_defs</a></li>
            
                <li><a href="../classes/global.Util.html">global.Util</a></li>
            
                <li><a href="../classes/server.Api.html">server.Api</a></li>
            
                <li><a href="../classes/server.Chat.html">server.Chat</a></li>
            
                <li><a href="../classes/server.CommandLine.html">server.CommandLine</a></li>
            
                <li><a href="../classes/server.Controller.html">server.Controller</a></li>
            
                <li><a href="../classes/server.Database.html">server.Database</a></li>
            
                <li><a href="../classes/server.Display.html">server.Display</a></li>
            
                <li><a href="../classes/server.Game.html">server.Game</a></li>
            
                <li><a href="../classes/server.games.AbstractGame.html">server.games.AbstractGame</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.html">server.games.SpielAufZeit</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Block.html">server.games.SpielAufZeit.Block</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Blockelement.html">server.games.SpielAufZeit.Blockelement</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Spieler.html">server.games.SpielAufZeit.Spieler</a></li>
            
                <li><a href="../classes/server.Main.html">server.Main</a></li>
            
                <li><a href="../classes/server.Profil.html">server.Profil</a></li>
            
                <li><a href="../classes/server.Router.html">server.Router</a></li>
            
                <li><a href="../classes/server.RouterChache.html">server.RouterChache</a></li>
            
                <li><a href="../classes/server.Server.html">server.Server</a></li>
            
                <li><a href="../classes/server.SpielTyp.html">server.SpielTyp</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/controller.html">controller</a></li>
            
                <li><a href="../modules/display.html">display</a></li>
            
                <li><a href="../modules/global.html">global</a></li>
            
                <li><a href="../modules/server.html">server</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: public/server/Server.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;
  
var Controller = require(&#x27;./Controller.js&#x27;).Controller;
var Display = require(&#x27;./Display.js&#x27;).Display;
var Game = require(&#x27;./Game.js&#x27;).Game;
var Profil = require(&#x27;./Profil.js&#x27;).Profil;
var Database = require(&#x27;./Database.js&#x27;).Database;
var SpielTyp = require(&#x27;./SpielTyp.js&#x27;).SpielTyp;
var CONFIG = require(&#x27;./../global/config.js&#x27;).CONFIG;
var Util = require(&#x27;./../global/Util.js&#x27;).Util;
var DB = require(&#x27;./../global/db.js&#x27;).DB;

/**
 * Konstruktor für Server
 *
 * @class Server
 * @constructor
 * @module server
 * @namespace server
 * @param {Object} httpserver
 */
function Server(httpserver) {
	/**
	 * @property _httpserver
	 * @type Object
	 * @private
	 */
	this._httpserver = httpserver;
	
	/**
	 * @property _socket
	 * @type socket@
	 * @private
	 */
	this._socket = require(&#x27;socket.io&#x27;);
	
	/**
	 * Instanz der Datenbank.
	 *
	 * @property _db
	 * @type server.Database
	 * @private
	 */
	this._db = null;
	
	/**
	 * Wert, die bei jeder Vergabe weiter hochgezählt wird im eindeutige ID während des Betriebes zu schaffen.
	 *
	 * @property _idPool
	 * @type Number
	 * @default 0
	 * @private
	 */
	this._idPool = 0;
	
	/**
	 * @property _io
	 * @type socket.io-instance
	 * @default null
	 * @private
	 */
	this._io = null;
	
	/**
	 * Hält eine Liste mit ALLEN Spielen.
	 *
	 * @property _games
	 * @type Array
	 * @default []
	 * @private
	 */
	this._games = [];
	
	/**
	 * Hält eine Liste mit ALLEN Profilen.
	 *
	 * @property _profils
	 * @type Array
	 * @default []
	 * @private
	 */
	this._profils = []; 
	
	/**
	 * Hält eine Liste mit allen SpielTypen.
	 *
	 * @property _spielTyps
	 * @type Array
	 * @default []
	 * @private
	 */
	this._spielTyps = [];
	
	/**
	 * Hält eine Liste mit ALLEN Controllern.
	 *
	 * @property _controllers
	 * @type Array
	 * @default []
	 * @private
	 */
	this._controllers = [];
	
	/**
	 * Hält eine Liste mit ALLEN Displays.
	 * 
	 * @property _displays
	 * @type Array
	 * @default []
	 * @private
	 */
	this._displays = [];
}

/**
 * Gibt die Datenbakverbindung wieder.
 *
 * @method getDB
 * @return {server.Database} die Datenbank
 */
Server.prototype.getDB = function(){
	return this._db;
};

/**
 * Listenerimplementierung
 *
 * @method receiveEvent
 * @param {String} eventName
 * @param {JSON} obj
 */
Server.prototype.receiveEvent = function(eventName, obj){
	switch(eventName){
		case &quot;SpielNoPlayers&quot;:
			this.deleteSpiel(obj);
			break;
		default:
			this.emitToAllControllers(eventName, obj);
	}
};

/**
 * Senden Nachrichten an _alle_ Verbundenen Controller.
 *
 * @method emitToAllControllers
 * @param {String} eventName der Event-Name
 * @param {JSON} obj das geänderte Object/die Daten
 */
Server.prototype.emitToAllControllers = function(eventName, obj){
	var i, controller;

	for(i in this._controllers){
		controller = this._controllers[i];
		controller.emitToController(eventName, obj);
	}
};

/**
 * Gibt alle Profile wieder.
 *
 * @method getAllProfils
 * @return {Array} Array mit allen Profilen
 */
Server.prototype.getAllProfils = function(){
	return this._profils;
};

/**
 * Gibt alle Spiele wieder.
 *
 * @method getAllGames
 * @return {Array}
 */
Server.prototype.getAllGames = function(){
	return this._games;
};

/**
 * Gibt ein SpielTyp anhand der ID wieder.
 * Stimmt die übergebene ID mit keiner SpielTyp ID über ein, wird null zurück gegeben.
 *
 * @method getSpielTypById
 * @param {Number} id die SpielTypID
 * @return {server.SpielTyp|null}
 */
Server.prototype.getSpielTypById = function(id){
	var i;
	for(i in this._spielTyps){
		if(this._spielTyps[i].getId() === id){
			return this._spielTyps[i];
		}
	}
	return null;
};

/**
 * Gibt ein Spiel anhand der ID wieder.
 * Stimmt die übergebene ID mit keiner SpieleID über ein, wird null zurück gegeben.
 *
 * @method getSpielById
 * @param {Number} id die SpielID
 * @return {server.Game|null} 
 */
Server.prototype.getSpielById = function(id){
	var i;
	for(i in this._games){
		if(this._games[i].getId() === id){
			return this._games[i];
		}
	}
	return null;
};

/**
 * Gibt den Profil mit der übergebene id wieder.
 * Stimmt die übergebene ID mit keiner Profil ID über ein, wird null zurück gegeben.
 * 
 * @method getProfilById
 * @param {Number} id die ProfilID
 * @return {server.Profil|null}
 */
Server.prototype.getProfilById = function(id){
	// lineare suche.. skaliert nicht wirklich schön. über eine datenbank wäre dies prettyer
	// ABER wir erwarten auch keine 100.000.000.000 Profile ;)
	var i, profil;
	
	for(i in this._profils){
		profil = this._profils[i];
		if(profil.getId() === id){
			return profil;
		}
	}
	return null;
};

/**
 * Fügt einen Spiel der Spielliste hinzu und hörcht. (receiveEvent)
 *
 * @method addSpiel
 * @param {server.Game} game Instanz der Klasse Spiel
 */
Server.prototype.addSpiel = function(spiel){
	this._games.push(spiel);
	spiel.addEventListener(this); // füge den Server als Listener hinzu
	this.emitToAllControllers(&quot;SpielAdded&quot;, spiel); 
	spiel.startEvents();
};

/**
 * Fügt einen Profil der Profilliste hinzu und hörcht. (receiveEvent)
 *
 * @method addProfil
 * @param {Profil} profil Instanz der Klasse Profil
 */
Server.prototype.addProfil = function(profil){
	this._profils.push(profil);
	profil.addEventListener(this); // füge den Server als Listener hinzu
	this.emitToAllControllers(&quot;ProfilAdded&quot;, profil); 
	profil.startEvents();
};

/**
 * Erstellt einen neuen Profil, fügt diesen der Profilliste hinzu und horcht.
 *
 * @method createProfil
 * @param {JSON} data Die Daten des Profils.
 * @param {Function} fn (optional) Callback, welches von einem socket ausgehen kann.
 * @param {Function} controller (optional) der Controller, der das Event ausgeführt hat. ruft dessen setProfil auf. 
 */
Server.prototype.createProfil = function(data, fn, controller){ 

	var Name = data.name;
	
	if(Name===&quot;&quot;){
		fn({ok: false, message: &quot;Der Name darf nicht leer sein.&quot;});
		return;
	}
	
	Profil.create(function(profil){	
	
		if(profil){
			profil.setName(Name);
	   		this.addProfil(profil);
		
	   		if(controller !== undefined){
		   		controller.setProfil(profil);   
		   	}
			if(fn !== undefined){
				var ret = profil.getEmitData();
				ret.ok = true;
				fn(ret);
			}
			profil.save();
	   	}else{
			if(fn !== undefined){
				var ret = {};
				ret.ok = false;
				ret.message = &quot;Konnte das Profil nicht erstellen.&quot;;
				fn(ret);
			}
	   	}

	}.bind(this));
};

/**
 * Erstellt einen neuen Spiel, fügt diesen der Spielliste hinzu und horcht.
 *
 * @method createGame
 * @param {JSON} data Die Daten des Spiels.
 * @param {Function} [fn] Callback, welches von einem socket ausgehen kann.
 */
Server.prototype.createGame = function(data, fn){
	var ersteller = this.getProfilById(data.ProfilID);
	var maxProfil = data.MaxProfil;
	var spielTyp = this.getSpielTypById(data.SpielTypID);

	Game.create(function(game){
		game.setMaxProfil(maxProfil);
		game.setSpielTyp(spielTyp);
		game.setErsteller(ersteller);
		game.addMitprofil(ersteller, true);
		
   		this.addSpiel(game); 
		
		if(fn !== undefined){
			var ret = game.getEmitData();
			ret.ok = true;
			fn(ret);
		}
	}.bind(this));
};

/**
 * LÖSCHT Spiel aus der DB
 *
 * @method deleteSpiel
 * @param {server.Game} spiel
 */
Server.prototype.deleteSpiel = function(spiel){
	this.emitToAllControllers(&quot;SpielDeleted&quot;, spiel);
	spiel.stopEvents();
	this.removeSpiel(spiel);
	spiel.delete();
};

/**
 * Entfernt Spiel aus der Liste, NICHT aus der DB
 *
 * @method removeSpiel
 * @param {server.Game} spiel
 */
Server.prototype.removeSpiel = function(spiel){
	//spiel.removeEventListener(this); &lt;- relevant?
	spiel.destruct();
	this._games = Util.delArray(this._games, spiel); 
};
  

/**
 * Start des Servers.
 *
 * @method start
 */
Server.prototype.start = function(){
	
	
	// Datenbank
	this._db = new Database(DB.host, DB.user, DB.password);
	this._db.connectDatabase(DB.name, DB.create_database);

	Game.setServer(this);
	Profil.setServer(this);
	Controller.setServer(this);
	Display.setServer(this);

	// lade Profil
	var sqlProfil = &quot;SELECT ProfilID FROM Profil ORDER BY Name ASC&quot;;
	
	this._db.query(sqlProfil, [], function(err, result){
   		if(err){ throw err; }
   		var i, row, profil;
   		   		
   		for(i in result){
	   		row = result[i];
   			profil = new Profil(row.ProfilID);
   			profil.load();
   			this.addProfil(profil);
   		
   		}
	}.bind(this));

	// lade Spiele
	//Der Server ist grade erst gestartet, es gibt keine Spiele, die grad laufen..
	var sqlSpiel = &quot;SELECT SpielID FROM Spiel&quot;;
	
	this._db.query(sqlSpiel, [], function(err, result){
   		if(err){ throw err; }
   		var i, row, spiel;
   		   		
   		for(i in result){
	   		row = result[i];
   			Game.getGameById(row.SpielID, this, function(o){
   				this.addSpiel(o);
   			}.bind(this));
   		
   		}
	}.bind(this));
	
	
	// lade Spieltypen
	var sqlSpieltyp = &quot;SELECT * FROM SpielTyp ORDER BY Bezeichnung&quot;;
	
	this._db.query(sqlSpieltyp, [], function(err, result){
   		if(err){ throw err; }
   		var i, row, spielTyp;
   		
   		for(i in result){
	   		row = result[i];
   			spielTyp = new SpielTyp(row.SpielTypID, row.Bezeichnung, row.Class);
   			this._spielTyps.push(spielTyp);
   		
   		}
	}.bind(this));
	
	
	// binde Sockets
	this._io = this._socket.listen(this._httpserver, { 
		log: false
	});
	
	
	this._io.sockets.on(&#x27;connection&#x27;, function(socket) {
	
		var id, type, obj;
		
		id = this._idPool++;
		type = null;
		obj = null;
	
		socket.on(&#x27;connectController&#x27;, function (data, fn) {
			type = &quot;controller&quot;;
			obj = new Controller(id, socket);
			this._controllers.push(obj);
			
			fn({id: id});
		}.bind(this));
	
		socket.on(&#x27;connectDisplay&#x27;, function (data, fn) {
			type = &quot;display&quot;;
			obj = new Display(id, socket);
			this._displays.push(obj);
			fn(id);
		}.bind(this));
		
		socket.on(&#x27;disconnect&#x27;, function () {
			if(type===&quot;controller&quot;){
				Util.delArray(this._controllers, obj);
				obj.destructor();
			}
			if(type===&quot;display&quot;){
				Util.delArray(this._displays, obj);
				obj.destructor();
			}
		}.bind(this));
		
	}.bind(this));
	
	console.log(&#x27;läuft.&#x27;);
};

/**
 * Stoppt des Servers.
 *
 * @method stop
 */
Server.prototype.stop = function(){
	console.log(&#x27;Stopping Server (not correct implemented yet).&#x27;);
	process.exit();
};

/**
 * Startet den Server neu.
 *
 * @method restart
 */
Server.prototype.restart = function(){
	console.log(&#x27;Restart Server (not correct implemented yet).&#x27;);
	process.exit();
};

exports.Server = Server;

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
