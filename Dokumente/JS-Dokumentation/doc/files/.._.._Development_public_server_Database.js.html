<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../Development/public/server/Database.js - Muliplayer Tetris</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png">Muliplayer Tetris: ../../Development/public/server/Database.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/controller.html">controller</a>
                
                </li>
            
                <li><a href="../modules/display.html">display</a>
                
                </li>
            
                <li><a href="../modules/global.html">global</a>
                
                </li>
            
                <li><a href="../modules/server.html">server</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Classes</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/controller.Auswahl.html">controller.Auswahl</a></li>
            
                <li><a href="../classes/controller.Chat.html">controller.Chat</a></li>
            
                <li><a href="../classes/controller.Controller.html">controller.Controller</a></li>
            
                <li><a href="../classes/display.AfterGame.html">display.AfterGame</a></li>
            
                <li><a href="../classes/display.Display.html">display.Display</a></li>
            
                <li><a href="../classes/display.Lounge.html">display.Lounge</a></li>
            
                <li><a href="../classes/display.MyAudio.html">display.MyAudio</a></li>
            
                <li><a href="../classes/display.Spieler.html">display.Spieler</a></li>
            
                <li><a href="../classes/global.API_SCHEMA.html">global.API_SCHEMA</a></li>
            
                <li><a href="../classes/global.BUTTON.html">global.BUTTON</a></li>
            
                <li><a href="../classes/global.BUTTONTYPE.html">global.BUTTONTYPE</a></li>
            
                <li><a href="../classes/global.CONFIG.html">global.CONFIG</a></li>
            
                <li><a href="../classes/global.GAME_EVENT.html">global.GAME_EVENT</a></li>
            
                <li><a href="../classes/global.LIST_EVENT.html">global.LIST_EVENT</a></li>
            
                <li><a href="../classes/global.pre_defs.html">global.pre_defs</a></li>
            
                <li><a href="../classes/global.Util.html">global.Util</a></li>
            
                <li><a href="../classes/server.Api.html">server.Api</a></li>
            
                <li><a href="../classes/server.Chat.html">server.Chat</a></li>
            
                <li><a href="../classes/server.CommandLine.html">server.CommandLine</a></li>
            
                <li><a href="../classes/server.Controller.html">server.Controller</a></li>
            
                <li><a href="../classes/server.Database.html">server.Database</a></li>
            
                <li><a href="../classes/server.Display.html">server.Display</a></li>
            
                <li><a href="../classes/server.Game.html">server.Game</a></li>
            
                <li><a href="../classes/server.games.AbstractGame.html">server.games.AbstractGame</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.html">server.games.SpielAufZeit</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Block.html">server.games.SpielAufZeit.Block</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Blockelement.html">server.games.SpielAufZeit.Blockelement</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Spieler.html">server.games.SpielAufZeit.Spieler</a></li>
            
                <li><a href="../classes/server.Main.html">server.Main</a></li>
            
                <li><a href="../classes/server.Profil.html">server.Profil</a></li>
            
                <li><a href="../classes/server.Router.html">server.Router</a></li>
            
                <li><a href="../classes/server.RouterChache.html">server.RouterChache</a></li>
            
                <li><a href="../classes/server.Server.html">server.Server</a></li>
            
                <li><a href="../classes/server.SpielTyp.html">server.SpielTyp</a></li>
            
        </ul>
    </div>
</div>










<div id="fileTree" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Files</h2>
    </div>
    <div class="bd">
        <ul><li>../<ul><li>../<ul><li>Development/<ul><li>public/<ul><li>controller/<ul><li><a href="../files/.._.._Development_public_controller_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_controller_Auswahl.js.html">Auswahl.js</a></li><li><a href="../files/.._.._Development_public_controller_Chat.js.html">Chat.js</a></li><li><a href="../files/.._.._Development_public_controller_Controller.js.html">Controller.js</a></li></ul></li><li>display/<ul><li><a href="../files/.._.._Development_public_display_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_display_AfterGame.js.html">AfterGame.js</a></li><li><a href="../files/.._.._Development_public_display_Display.js.html">Display.js</a></li><li><a href="../files/.._.._Development_public_display_Lounge.js.html">Lounge.js</a></li><li><a href="../files/.._.._Development_public_display_MyAudio.js.html">MyAudio.js</a></li><li><a href="../files/.._.._Development_public_display_Spieler.js.html">Spieler.js</a></li></ul></li><li>global/<ul><li><a href="../files/.._.._Development_public_global_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_global_Util.js.html">Util.js</a></li><li><a href="../files/.._.._Development_public_global_api-schema.js.html">api-schema.js</a></li><li><a href="../files/.._.._Development_public_global_config.js.html">config.js</a></li><li><a href="../files/.._.._Development_public_global_db.js.html">db.js</a></li><li><a href="../files/.._.._Development_public_global_enum_controller_buttons.js.html">enum_controller_buttons.js</a></li><li><a href="../files/.._.._Development_public_global_events.js.html">events.js</a></li></ul></li><li>highscore/<ul><li><a href="../files/.._.._Development_public_highscore_highscore.js.html">highscore.js</a></li></ul></li><li>profil/<ul><li><a href="../files/.._.._Development_public_profil_profil.js.html">profil.js</a></li></ul></li><li>server/<ul><li><a href="../files/.._.._Development_public_server_Api.js.html">Api.js</a></li><li><a href="../files/.._.._Development_public_server_Chat.js.html">Chat.js</a></li><li><a href="../files/.._.._Development_public_server_CommandLine.js.html">CommandLine.js</a></li><li><a href="../files/.._.._Development_public_server_Controller.js.html">Controller.js</a></li><li><a href="../files/.._.._Development_public_server_Database.js.html">Database.js</a></li><li><a href="../files/.._.._Development_public_server_Display.js.html">Display.js</a></li><li><a href="../files/.._.._Development_public_server_Game.js.html">Game.js</a></li><li>Games/<ul><li><a href="../files/.._.._Development_public_server_Games_AbstractGame.js.html">AbstractGame.js</a></li><li>SpielAufZeit/<ul><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Block.js.html">Block.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Blockelement.js.html">Blockelement.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_SpielAufZeit.js.html">SpielAufZeit.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Spieler.js.html">Spieler.js</a></li></ul></li></ul></li><li><a href="../files/.._.._Development_public_server_Main.js.html">Main.js</a></li><li><a href="../files/.._.._Development_public_server_Profil.js.html">Profil.js</a></li><li><a href="../files/.._.._Development_public_server_Router.js.html">Router.js</a></li><li><a href="../files/.._.._Development_public_server_RouterChache.js.html">RouterChache.js</a></li><li><a href="../files/.._.._Development_public_server_Server.js.html">Server.js</a></li><li><a href="../files/.._.._Development_public_server_SpielTyp.js.html">SpielTyp.js</a></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>
    </div>
</div>



        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>../../Development/public/server/Database.js</h4>

<pre class="code prettyprint linenums">
&quot;use strict&quot;;

var Util = require(&#x27;./../global/Util.js&#x27;).Util;
//var Q = require(&#x27;q&#x27;); see http://old.erickrdch.com/2012/07/nodejs-and-mysql.html

/**
 * Klasse zum Erstellen und Verwalten der Datenbank
 *
 * @module server
 * @namespace server
 * @class Database
 * @constructor
 * @param {String} host der zu verbindende Host
 * @param {String} user der Benutzername des Datenbankservers
 * @param {String} password das Passwort des Benutzers
 */
function Database(host, user, password){
	/**
	 * @property _mysql
	 * @type mysql
	 * @private
	 */
	this._mysql = require(&#x27;mysql&#x27;);
	
	/**
	 * @property _conn
	 * @type Connection
	 * @private
	 */
	this._conn = this._connectDB(host, user, password);
}

/**
 * @method escape
 *
 * @param {String} value
 */
Database.prototype.escape = function(value){
	return this._mysql.escape(value);
}

/**
 * Durchreichen zum query.
 *
 * @method query
 * @async
 * @param {String} sql
 * @param {Array} params
 * @param {Function} callback
 */
Database.prototype.query = function(sql, params, callback){
	if(params.length !== 0 &amp;&amp; params[0] !== undefined &amp;&amp; params[0].length){
		for(var i in params){
			this._conn.query(sql, params[i], callback);
		}
	}else{
		this._conn.query(sql,params, callback);
	}
};

/**
 * Erstellt die Datenbankverbindung.
 *
 * @method _connectDB
 * @private
 * @async
 * @param {String} host der zu verbindende Host
 * @param {String} user der Benutzername des Datenbankservers
 * @param {String} password das Passwort des Benutzers
 * @return die Verbindung
 */
Database.prototype._connectDB = function(host, user, password){

	var conn = new this._mysql.createConnection({
	    host     : host,
	    user     : user,
	    password : password
	});
	
	conn.connect(function(err) {
	    if(err){
	        console.log(&quot;ERROR: Konnte nicht mit dem MySQL-Server verbinden. Läuft dieser?\n&quot;);
	    	console.log(err);
	        process.exit(1);
	    }
	});
		
	return conn;
};

/**
 * Erstellt die Datenbank, falls diese noch nicht existiert.
 *
 * @param {String} database der Name der Datenbank
 * @param {Boolean} create_database gibt an, ob die Datenbank und dessen Daten inkl. Testdaten erstellt werden soll
 * @method connectDatabase
 */
Database.prototype.connectDatabase = function(database, create_database){
	if(create_database === undefined){
		create_database = true;
	}

	var drop = &#x27;DROP DATABASE IF EXISTS &#x27;+database+&#x27;; &#x27;;
	var create = &#x27;CREATE DATABASE IF NOT EXISTS &#x27;+database+&#x27; CHARACTER SET utf8 COLLATE utf8_unicode_ci; &#x27;;
	var sqlUse = &#x27;USE &#x27;+database;
	
	var sqlProfil = &quot;&quot;
	+ &quot;CREATE TABLE IF NOT EXISTS Profil(&quot;
	+ &quot; ProfilID INT NOT NULL AUTO_INCREMENT, &quot;
	+ &quot; Name VARCHAR(30) NOT NULL UNIQUE KEY, &quot;
	+ &quot; AnmeldeDatum TIMESTAMP NOT NULL DEFAULT NOW(), &quot;
	+ &quot; LetzteAnmeldung TIMESTAMP, &quot;
	+ &quot; PRIMARY KEY(ProfilID) &quot;
	+ &quot;) ENGINE=InnoDB;&quot;;
	
	var sqlScore = &quot;&quot;
	+ &quot;CREATE TABLE IF NOT EXISTS Score(&quot;
	+ &quot; ProfilID INT NOT NULL REFERENCES Profil(ProfilID), &quot;
	+ &quot; SpielID INT NOT NULL REFERENCES Spiel(SpielID), &quot;
	+ &quot; Punkte INT NOT NULL DEFAULT 0, &quot;
	+ &quot; GesetzteBloecke INT NOT NULL DEFAULT 0, &quot;
	+ &quot; Tastenanschlaege INT NOT NULL DEFAULT 0, &quot;
	+ &quot; PRIMARY KEY(ProfilID, SpielID) &quot;
	+ &quot;) ENGINE=InnoDB;&quot;;
	
	var sqlSpiel = &quot;&quot;
	+ &quot;CREATE TABLE IF NOT EXISTS Spiel(&quot;
	+ &quot; SpielID INT NOT NULL AUTO_INCREMENT, &quot;
	+ &quot; MaxProfil INT NOT NULL DEFAULT 4, &quot;
	+ &quot; Dauer INT NOT NULL DEFAULT 0, &quot;
	+ &quot; SpielTypID INT NOT NULL REFERENCES SpielTyp(SpielTypID), &quot; 
	+ &quot; ProfilID INT NOT NULL REFERENCES Profil(ProfilID), &quot; // Profil, das das Spiel erstellt hat.
	+ &quot; Statistiken TEXT, &quot;
	+ &quot; Datum TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP, &quot;
	+ &quot; PRIMARY KEY(SpielID) &quot;
	+ &quot;) ENGINE=InnoDB;&quot;;
	
	var sqlSpielTyp = &quot;&quot;
	+ &quot;CREATE TABLE IF NOT EXISTS SpielTyp(&quot;
	+ &quot; SpielTypID INT NOT NULL AUTO_INCREMENT, &quot;
	+ &quot; Bezeichnung VARCHAR(30) NOT NULL, &quot;
	+ &quot; Class VARCHAR(30) NOT NULL, &quot;
	+ &quot; PRIMARY KEY(SpielTypID) &quot;
	+ &quot;) ENGINE=InnoDB;&quot;;
	
	var sqlProfil_Spielt_Spiel = &quot;&quot;
	+ &quot;CREATE TABLE IF NOT EXISTS Profil_Spielt_Spiel(&quot;
	+ &quot; ProfilID INT NOT NULL REFERENCES Profil(ProfilID), &quot;
	+ &quot; SpielID INT NOT NULL REFERENCES Spiel(SpielID), &quot;
	+ &quot; PRIMARY KEY(ProfilID, SpielID) &quot;
	+ &quot;) ENGINE=InnoDB;&quot;;
	
	var sqlHigscore = &quot;&quot;
	+ &quot;CREATE VIEW Highscore AS (&quot;
	+ &quot; SELECT Profil.ProfilID, &quot;
	+ &quot;        Profil.Name, &quot;
	+ &quot;        Profil.LetzteAnmeldung, &quot;
	+ &quot;        COUNT(Spiel.SpielID) AS Spieleanzahl, &quot;
	+ &quot;        SUM(Spiel.Dauer) AS Gesamtdauer, &quot;
	+ &quot;        SUM(Score.Punkte) AS Punkte, &quot;
	+ &quot;        SUM(Score.GesetzteBloecke) AS GesetzteBloecke, &quot;
	+ &quot;        SUM(Score.Tastenanschlaege) AS Tastenanschlaege &quot;
	+ &quot; FROM Score &quot;
	+ &quot; RIGHT JOIN Spiel ON Score.SpielID = Spiel.SpielID &quot;
	+ &quot; RIGHT JOIN Profil ON Profil.ProfilID = Score.ProfilID &quot;
	+ &quot; GROUP BY Profil.ProfilID&quot;
	+ &quot;);&quot;;

	var sqlHigscore_SpielTyp = &quot;&quot;
	+ &quot;CREATE VIEW HighscoreSpielTyp AS (&quot;
	+ &quot; SELECT Profil.ProfilID, &quot;
	+ &quot;        Profil.Name, &quot;
	+ &quot;        Profil.LetzteAnmeldung, &quot;
	+ &quot; 	   Spiel.SpielTypID AS SpielTyp, &quot;
	+ &quot;        COUNT(Spiel.SpielID) AS Spieleanzahl, &quot;
	+ &quot;        SUM(Spiel.Dauer) AS Gesamtdauer, &quot;
	+ &quot;        SUM(Score.Punkte) AS Punkte, &quot;
	+ &quot;        SUM(Score.GesetzteBloecke) AS GesetzteBloecke, &quot;
	+ &quot;        SUM(Score.Tastenanschlaege) AS Tastenanschlaege &quot;
	+ &quot; FROM Score &quot;
	+ &quot; RIGHT JOIN Spiel ON Score.SpielID = Spiel.SpielID &quot;
	+ &quot; RIGHT JOIN Profil ON Profil.ProfilID = Score.ProfilID &quot;
	+ &quot; GROUP BY Profil.ProfilID, Spiel.SpielTypID&quot;
	+ &quot;);&quot;;
	
	var sqlInsertProfil = &quot;INSERT INTO Profil SET ProfilID = ?, Name = ?;&quot;;
	var sqlInsertSpielTyp = &quot;INSERT INTO SpielTyp SET SpielTypID = ?, Bezeichnung = ?, Class = ?;&quot;;
	var sqlInsertSpiel = &quot;INSERT INTO Spiel SET SpielTypID = ?, ProfilID = ?, Dauer = ?;&quot;;
	var sqlInsertScore = &quot;INSERT INTO Score SET ProfilID = ?, SpielID = ?, Punkte = ?, GesetzteBloecke = ?, Tastenanschlaege = ?;&quot;;
	var sqlInsertProfil_Spiel = &quot;INSERT INTO Profil_Spielt_Spiel SET ProfilID = ?, SpielID = ?;&quot;;

	
	if(create_database){
		this.query(drop, function (err) { if(err) throw err; });
		this.query(create, function (err) { if(err) throw err; });
		this.query(sqlUse, function (err) { if(err) throw err; });
		this.query(sqlProfil, function(err){ if(err) throw err; });
		this.query(sqlScore, function(err){ if(err) throw err; });
		this.query(sqlSpiel, function(err){ if(err) throw err; });
		this.query(sqlSpielTyp, function(err){ if(err) throw err; });
		this.query(sqlProfil_Spielt_Spiel, function(err){ if(err) throw err; });
		this.query(sqlHigscore, function(err){ if(err) throw err; });
		this.query(sqlHigscore_SpielTyp, function(err){ if(err) throw err; });
		
		// Exampledata

		//Profil-Angaben (ProfilID, Name)
		var profilDaten = [
			[1, &quot;Anna&quot;],
			[2, &quot;Nici&quot;],
			[3, &quot;Cengiz&quot;],
			[4, &quot;Peter&quot;],
			[5, &quot;Maggi&quot;],
			[6, &quot;Lui&quot;],
			[7, &quot;Johannes&quot;],
			[8, &quot;Tobi&quot;],
			[9, &quot;Tim&quot;],
			[10, &quot;Jana&quot;],
			[11, &quot;Julia&quot;],
			[12, &quot;Susi&quot;],
			[13, &quot;Rudi&quot;],
			[14, &quot;Hartweizen&quot;],
			[15, &quot;John Schnee&quot;],
			[16, &quot;Ned Stark&quot;],
			[17, &quot;Kevin&quot;],
			[18, &quot;Jeromy&quot;],
			[19, &quot;Chris&quot;],
			[20, &quot;Coraline&quot;],
			[21, &quot;Julian&quot;],
			[22, &quot;Luna&quot;],
			[23, &quot;Loriot&quot;],
			[24, &quot;Kahl Drogo&quot;],
			[25, &quot;Schattenwolf&quot;],
			[26, &quot;Krasus&quot;],
			[27, &quot;Lena&quot;],
			[28, &quot;Robin&quot;],
			[29, &quot;Veressa&quot;],
			[30, &quot;Caroline&quot;],
		];
		this.query(sqlInsertProfil, profilDaten);
		

		//SpielTyp-Angaben (SpielTypID, Bezeichnung, Class)
		var spielTypDaten = [
			[1, &quot;Spiel auf Zeit&quot;, &quot;SpielAufZeit&quot;],
			[2, &quot;Deathmatch&quot;, &quot;none&quot;],
			[3, &quot;Last Man Standing&quot;, &quot;none&quot;],
		];
		this.query(sqlInsertSpielTyp, spielTypDaten);
		
		
		var spielDaten = [];
		var scoreDaten = [];
		var profil_spieltDaten = [];
		var proID;
		var spielID;
		for(var i = 0; i &lt; 500; i++){
			//Spiel-Angaben (SpielTypID, ProfilID, Dauer)
			spielDaten.push([Util.randInteger(1, spielTypDaten.length+1), Util.randInteger(1, profilDaten.length), Util.randInteger(0,600)]);
			
			var o = [];
			for(var j = 0; j &lt; Util.randInteger(1,4); j++){
				
				do{
					proID = Util.randInteger(1, profilDaten.length+1);
				}while(Util.inArray(o, proID));
				
				o.push(proID);
				spielID = i+1;
				
				
				//Score-Angaben (ProfilID, SpielID, Punkte, gesetzte Bloecke, Tastenanschlaege)
				scoreDaten.push([proID, spielID, Util.randInteger(0,100000), Util.randInteger(0,1000), Util.randInteger(0,3000)]);
				
				//Profil_Spielt_Spiel-Angaben (ProfilID, SpielID)
				profil_spieltDaten.push([proID, spielID]);
			}
		}
		this.query(sqlInsertSpiel, spielDaten);
		this.query(sqlInsertScore, scoreDaten);
		this.query(sqlInsertProfil_Spiel, profil_spieltDaten);
		

	}else{
		this.query(sqlUse, function (err) {});
	}
};

exports.Database = Database;

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
