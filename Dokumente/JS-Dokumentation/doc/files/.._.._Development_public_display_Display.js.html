<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../Development/public/display/Display.js - Muliplayer Tetris</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png">Muliplayer Tetris: ../../Development/public/display/Display.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.9</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Modules</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../modules/controller.html">controller</a>
                
                </li>
            
                <li><a href="../modules/display.html">display</a>
                
                </li>
            
                <li><a href="../modules/global.html">global</a>
                
                </li>
            
                <li><a href="../modules/server.html">server</a>
                
                </li>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Classes</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/controller.Auswahl.html">controller.Auswahl</a></li>
            
                <li><a href="../classes/controller.Chat.html">controller.Chat</a></li>
            
                <li><a href="../classes/controller.Controller.html">controller.Controller</a></li>
            
                <li><a href="../classes/display.AfterGame.html">display.AfterGame</a></li>
            
                <li><a href="../classes/display.Display.html">display.Display</a></li>
            
                <li><a href="../classes/display.Lounge.html">display.Lounge</a></li>
            
                <li><a href="../classes/display.MyAudio.html">display.MyAudio</a></li>
            
                <li><a href="../classes/display.Spieler.html">display.Spieler</a></li>
            
                <li><a href="../classes/global.API_SCHEMA.html">global.API_SCHEMA</a></li>
            
                <li><a href="../classes/global.BUTTON.html">global.BUTTON</a></li>
            
                <li><a href="../classes/global.BUTTONTYPE.html">global.BUTTONTYPE</a></li>
            
                <li><a href="../classes/global.CONFIG.html">global.CONFIG</a></li>
            
                <li><a href="../classes/global.GAME_EVENT.html">global.GAME_EVENT</a></li>
            
                <li><a href="../classes/global.LIST_EVENT.html">global.LIST_EVENT</a></li>
            
                <li><a href="../classes/global.pre_defs.html">global.pre_defs</a></li>
            
                <li><a href="../classes/global.Util.html">global.Util</a></li>
            
                <li><a href="../classes/server.Api.html">server.Api</a></li>
            
                <li><a href="../classes/server.Chat.html">server.Chat</a></li>
            
                <li><a href="../classes/server.CommandLine.html">server.CommandLine</a></li>
            
                <li><a href="../classes/server.Controller.html">server.Controller</a></li>
            
                <li><a href="../classes/server.Database.html">server.Database</a></li>
            
                <li><a href="../classes/server.Display.html">server.Display</a></li>
            
                <li><a href="../classes/server.Game.html">server.Game</a></li>
            
                <li><a href="../classes/server.games.AbstractGame.html">server.games.AbstractGame</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.html">server.games.SpielAufZeit</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Block.html">server.games.SpielAufZeit.Block</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Blockelement.html">server.games.SpielAufZeit.Blockelement</a></li>
            
                <li><a href="../classes/server.games.SpielAufZeit.Spieler.html">server.games.SpielAufZeit.Spieler</a></li>
            
                <li><a href="../classes/server.Main.html">server.Main</a></li>
            
                <li><a href="../classes/server.Profil.html">server.Profil</a></li>
            
                <li><a href="../classes/server.Router.html">server.Router</a></li>
            
                <li><a href="../classes/server.RouterChache.html">server.RouterChache</a></li>
            
                <li><a href="../classes/server.Server.html">server.Server</a></li>
            
                <li><a href="../classes/server.SpielTyp.html">server.SpielTyp</a></li>
            
        </ul>
    </div>
</div>










<div id="fileTree" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Files</h2>
    </div>
    <div class="bd">
        <ul><li>../<ul><li>../<ul><li>Development/<ul><li>public/<ul><li>controller/<ul><li><a href="../files/.._.._Development_public_controller_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_controller_Auswahl.js.html">Auswahl.js</a></li><li><a href="../files/.._.._Development_public_controller_Chat.js.html">Chat.js</a></li><li><a href="../files/.._.._Development_public_controller_Controller.js.html">Controller.js</a></li></ul></li><li>display/<ul><li><a href="../files/.._.._Development_public_display_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_display_AfterGame.js.html">AfterGame.js</a></li><li><a href="../files/.._.._Development_public_display_Display.js.html">Display.js</a></li><li><a href="../files/.._.._Development_public_display_Lounge.js.html">Lounge.js</a></li><li><a href="../files/.._.._Development_public_display_MyAudio.js.html">MyAudio.js</a></li><li><a href="../files/.._.._Development_public_display_Spieler.js.html">Spieler.js</a></li></ul></li><li>global/<ul><li><a href="../files/.._.._Development_public_global_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_global_Util.js.html">Util.js</a></li><li><a href="../files/.._.._Development_public_global_api-schema.js.html">api-schema.js</a></li><li><a href="../files/.._.._Development_public_global_config.js.html">config.js</a></li><li><a href="../files/.._.._Development_public_global_db.js.html">db.js</a></li><li><a href="../files/.._.._Development_public_global_enum_controller_buttons.js.html">enum_controller_buttons.js</a></li><li><a href="../files/.._.._Development_public_global_events.js.html">events.js</a></li></ul></li><li>highscore/<ul><li><a href="../files/.._.._Development_public_highscore_highscore.js.html">highscore.js</a></li></ul></li><li>profil/<ul><li><a href="../files/.._.._Development_public_profil_profil.js.html">profil.js</a></li></ul></li><li>server/<ul><li><a href="../files/.._.._Development_public_server_Api.js.html">Api.js</a></li><li><a href="../files/.._.._Development_public_server_Chat.js.html">Chat.js</a></li><li><a href="../files/.._.._Development_public_server_CommandLine.js.html">CommandLine.js</a></li><li><a href="../files/.._.._Development_public_server_Controller.js.html">Controller.js</a></li><li><a href="../files/.._.._Development_public_server_Database.js.html">Database.js</a></li><li><a href="../files/.._.._Development_public_server_Display.js.html">Display.js</a></li><li><a href="../files/.._.._Development_public_server_Game.js.html">Game.js</a></li><li>Games/<ul><li><a href="../files/.._.._Development_public_server_Games_AbstractGame.js.html">AbstractGame.js</a></li><li>SpielAufZeit/<ul><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_.Modul.js.html">.Modul.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Block.js.html">Block.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Blockelement.js.html">Blockelement.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_SpielAufZeit.js.html">SpielAufZeit.js</a></li><li><a href="../files/.._.._Development_public_server_Games_SpielAufZeit_Spieler.js.html">Spieler.js</a></li></ul></li></ul></li><li><a href="../files/.._.._Development_public_server_Main.js.html">Main.js</a></li><li><a href="../files/.._.._Development_public_server_Profil.js.html">Profil.js</a></li><li><a href="../files/.._.._Development_public_server_Router.js.html">Router.js</a></li><li><a href="../files/.._.._Development_public_server_RouterChache.js.html">RouterChache.js</a></li><li><a href="../files/.._.._Development_public_server_Server.js.html">Server.js</a></li><li><a href="../files/.._.._Development_public_server_SpielTyp.js.html">SpielTyp.js</a></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul>
    </div>
</div>



        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>../../Development/public/display/Display.js</h4>

<pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * Konstruktor für Display
 *
 * @module display
 * @namespace display
 * @class Display
 * @constructor
 * @param {String} serverAdress
 */
function Display(serverAdress){
	/**
	 * @property _socket
	 * @type Socket
	 * @default null
	 * @private
	 */
	this._socket = null;
	
	/**
	 * ID des Displays
	 *
	 * @property _id
	 * @type Number
	 * @default null
	 * @private
	 */
	this._id = null;
	
	/**
	 * Adresse des Server
	 *
	 * @property _serverAdress
	 * @type String
	 * @private
	 */
	this._serverAdress = serverAdress;
	
	/**
	 * @property _buttonsDown
	 * @type Array
	 * @default []
	 * @private
	 */
	this._buttonsDown = [];
	
	/**
	 * ID des Profil, welches verfolgt werden soll
	 *
	 * @property _spielerId
	 * @type Number
	 * @default null
	 * @private
	 */
	this._spielerId = null;
	
	/**
	 * ID des Spiels, welches verfolgt werden soll
	 *
	 * @property _spielId
	 * @type Number
	 * @default null
	 * @private
	 */
	this._spielId = null;
	
	/**
	 * Breite
	 *
	 * @property _w
	 * @type Number
	 * @default null
	 * @private
	 */
	this._w = null;
	
	/**
	 * Höhe
	 *
	 * @property _h
	 * @type Number
	 * @default null
	 * @private
	 */
	this._h = null;
	
	/**
	 * Breite des Spielfelds
	 *
	 * @property _gamefieldW
	 * @type Number
	 * @default 1920
	 * @private
	 */
	this._gamefieldW = 1920; // intern width
	
	/**
	 * Höhre des Spielfelds
	 *
	 * @property _gamefieldH
	 * @type Number
	 * @default 1080
	 * @private
	 */
	this._gamefieldH = 1080; // intern height
	
	/**
	 * Seitenverhältnis des Spielfelds
	 *
	 * @property _aspectratio
	 * @type Number
	 * @default _w/_h
	 * @private
	 */
	this._aspectratio = this._gamefieldW / this._gamefieldH;
	
	/**
	 * @property _field_w
	 * @type Number
	 * @default null
	 * @private
	 */
	this._field_w = null;
	
	/**
	 * @property _field_h
	 * @type Number
	 * @default null
	 * @private
	 */
	this._field_h = null;
	
	/**
	 * @property _gameEventBuffer
	 * @type Array
	 * @default []
	 * @private
	 */
	this._gameEventBuffer = [];
	
	/**
	 * @property _tickCounter
	 * @type Number
	 * @default 0
	 * @private
	 */
	this._tickCounter = 0;
	
	/**
	 * Inerval-Instance
	 * @property _instance
	 * @type Interval
	 * @default null
	 * @private
	 */
	this._instance = null;
	
	/**
	 * Frame per Second
	 *
	 * @property _fps
	 * @type Number
	 * @default 1000/60
	 * @private
	 */
	this._fps = 1000/60; // 1000/60
	
	/**
	 * Spieler, der verfolgt werden soll
	 *
	 * @property _spieler
	 * @type Object
	 * @default {}
	 * @private
	 */
	this._spieler = {};
			
	/**
	 * @property _connectionLost
	 * @type Boolean
	 * @default false
	 * @private
	 */
	this._connectionLost = false;
	
	/**
	 * @property _audio
	 * @type display.MyAudio
	 * @default new MyAudio()
	 * @private
	 */
	this._audio = new MyAudio();
	
	/**
	 *
	 *
	 * @property _lounge
	 * @type display.Lounge
	 * @default new Lounge(this)
	 * @private
	*/
	this._lounge = new Lounge(this);
	
	
	/**
	 *
	 *
	 * @property _afterGame
	 * @type display.AfterGame
	 * @default new AfterGame()
	 * @private
	*/
	this._afterGame = new AfterGame();
	
	// Lade die Sounds
	this._audio.load(&quot;blockRotate&quot;, &quot;sounds/N-Tick-Freak61-7778_hifi.mp3&quot;);
	this._audio.load(&quot;lineKill&quot;,    &quot;sounds/idg-bang-intermed-2959_hifi.mp3&quot;);
	this._audio.load(&quot;startGame&quot;,   &quot;sounds/Nice_Not-NEO_Soun-8393_hifi.mp3&quot;);
	this._audio.load(&quot;blockSolidate&quot;, &quot;sounds/cordless-xrikazen-7428_hifi.mp3&quot;);
	this._audio.load(&quot;spielerRaus&quot;, &quot;sounds/idg-bang-intermed-2937_hifi.mp3&quot;);
	//this._audio.load(&quot;SpielEnds&quot;, &quot;sounds/TODO&quot;);
	
}

/**
 * @method showMessage
 *
 * @param {String} text
 * @param {Boolean} [autoHide=false]
 * @param {Number} [width]
 */
Display.prototype.showMessage = function(text, autoHide, width){
	if(autoHide === undefined) autoHide = false;
	if(width === undefined) width = null;
	var style=&quot;&quot;;
	
	if(width !== null){
		style = &quot;style=&#x27;width:&quot;+width+&quot;px&#x27;&quot;;
	}
	
	var html = $(&quot;&lt;div class=&#x27;message&#x27; &quot;+style+&quot;&gt;&quot;+text+&quot;&lt;/div&gt;&quot;);
	$(&quot;body&quot;).append(html);
	var w = html.width()+50;
	var h = html.height()+50;
	html.css({
		marginLeft: &quot;-&quot;+(w/2)+&quot;px&quot;,
		marginTop: &quot;-&quot;+(h/2)+&quot;px&quot;
	});
	
	//flash
	var flash = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
	flash.css({
		position: &quot;absolute&quot;,
		left: &quot;-4px&quot;,
		top: &quot;-4px&quot;,
		bottom: &quot;-4px&quot;,
		right: &quot;-4px&quot;,
		backgroundColor: &quot;white&quot;
	}).animate({
		opacity: 0
	}, 250, function(){
		$(this).remove();
	});
	html.append(flash);
	
	if(autoHide){
		setTimeout(function(html){
			return function(){
				html.animate({
					opacity: 0
				}, 500, function(){
					$(this).remove();
				});
			}
		}(html), autoHide);
	}
};

/**
 *
 *
 * @method removeAllMessage
 * @param {Boolean} [fast=false] 
 */
Display.prototype.removeAllMessage = function(fast){
	if(fast === undefined) fast = false;
	
	if(fast){
		$(&quot;.message&quot;).remove();
	}else{
		$(&quot;.message&quot;).animate({
			opacity: 0
		}, 500, function(){
			$(this).remove();
		});
	}
};

/**
 * Passt die Größe des Displays an die Fenstergröße an.
 *
 * @method resize
 */
Display.prototype.resize = function(){
	var winW = $(window).width();
	var winH = $(window).height();
	var scaleFactor = 1;
	
	if(winW/winH &gt; this._aspectratio){
		this._h = winH;
		this._w = this._aspectratio * this._h;
	}else{
		this._w = winW;
		this._h = this._w/this._aspectratio;
	}
	scaleFactor = (this._h/this._gamefieldH);
	
	// magic css3 &lt;3 -&gt; http://www.html5rocks.com/en/tutorials/speed/high-performance-animations/
	$(&quot;#gamefield&quot;).css({
		&quot;-webkit-transform&quot;: &quot;scale(&quot;+scaleFactor+&quot;)&quot;,
		&quot;-moz-transform&quot;: &quot;scale(&quot;+scaleFactor+&quot;)&quot;,
		&quot;-ms-transform&quot;: &quot;scale(&quot;+scaleFactor+&quot;)&quot;,
		&quot;-o-transform&quot;: &quot;scale(&quot;+scaleFactor+&quot;)&quot;,
		&quot;transform&quot;: &quot;scale(&quot;+scaleFactor+&quot;)&quot;,
	});
};

/**
 * @method showConnect
 */
Display.prototype.showConnect = function(){
	$(&quot;#AuswahlSpielSpieler&quot;).show();
};

/**
 * Gibt die ID des Displays zurück.
 *
 * @method getId
 *
 * @return {Number}
 */
Display.prototype.getId = function(){
	return this._id;
};

/**
 * Gibt die Höhe eines einzelnen Blockes zurück
 *
 * @method getBlockHeight
 *
 * @return {Number}
 */
Display.prototype.getBlockHeight = function(){
	return $(&quot;#blockfield&quot;).height() / this._field_h;
};

/**
 * Gibt die Breite eines einzelnen Blockes zurück
 *
 * @method getBlockWidth
 *
 * @return {Number}
 */
Display.prototype.getBlockWidth = function(){
	return this.getBlockHeight();	
};

/**
 * Erstellt eine Liste von Blöcken, welche dem Spielfeld angehängt werden.
 *
 * @method createBlockfield
 */
Display.prototype.createBlockfield = function(){
	var y, x, element,id,block_w,block_h;
	var elements = [];
	
	for(y = 0; y &lt; this._field_h; y++){
		for(x = 0; x &lt; this._field_w; x++){
			id = &quot;block_&quot;+x+&quot;_&quot;+y;
			element = this.createBlock(x, y, id);
			elements.push(element);
		}
	}
	$(&quot;#blockfield&quot;).append(elements);
};

/**
 * Erstellt ein Block an der Stelle x,y
 *
 * @method createBlock
 * @param {Number} x
 * @param {Number} y
 * @param {Number} id
 */
Display.prototype.createBlock = function(x, y, id){
	var block_w = this.getBlockWidth();
	var block_h = this.getBlockHeight();
	
	if(id !== undefined){
		id = &quot; id=&#x27;&quot;+id+&quot;&#x27;&quot;;
	}
	
	var element = $(&quot;&lt;div class=&#x27;block&#x27;&quot;+id+&quot;&gt;&lt;/div&gt;&quot;);
	element.css({
		left: (x*block_w)+&quot;px&quot;,
		top: (y*block_h)+&quot;px&quot;,
		width: block_w+&quot;px&quot;,
		height: block_h+&quot;px&quot;
	});
	return element;
};

/**
 * Erstellt ein Spielstein für das Profil spieler.
 *
 * @method createPlayerElement
 * @param {display.Spieler} spieler
 */
Display.prototype.createPlayerElement = function(spieler){
	var element, id, c;
	id = &quot;cursor_&quot;+spieler.getId();
	c = spieler.getColor();
	element = $(&quot;&lt;div class=&#x27;cursor&#x27; id=&#x27;&quot;+id+&quot;&#x27;&gt;&lt;/div&gt;&quot;);
	$(&quot;#blockfield&quot;).append(element);
	$(&quot;#&quot;+id).css(&quot;width&quot;,this.getBlockWidth()+&quot;px&quot;);
	$(&quot;#&quot;+id).css(&quot;background-color&quot;, &quot;rgb(&quot;+c[0]+&quot;,&quot;+c[1]+&quot;,&quot;+c[2]+&quot;)&quot;);	
};



/**
 * Zeigt den Namen und Punkte von spieler an.
 *
 * @method createPlayerInfos
 * @param {display.Spieler} spieler
 */
Display.prototype.createPlayerInfos = function(spieler){
	var id = &quot;playerInfo_&quot;+spieler.getId();
	var html = &quot;&lt;li id=&#x27;&quot;+id+&quot;&#x27;&gt;&quot;;
	html += &quot;&lt;span class=&#x27;playerPlatz&#x27;&gt;&quot;+spieler.getPlatz()+&quot;&lt;/span&gt;&quot;;
	html += &quot;&lt;span class=&#x27;playerColor&#x27; style=&#x27;background-color:rgb(&quot;+spieler.getColor()+&quot;)&#x27;&gt;&lt;/span&gt;&quot;;
	html += &quot;&lt;strong&gt;&quot;+spieler.getName()+&quot;&lt;/strong&gt;&quot;;
	html += &quot;&lt;span class=&#x27;playerPunkte&#x27;&gt;&quot;+spieler.getPunkte()+&quot;&lt;/span&gt;&lt;span&gt;&amp;nbsp;Punkte&lt;/span&gt;&quot;;
	html += &quot;&lt;/li&gt;&quot;
	$(&quot;#gameInfos ul&quot;).append(html);
	
	if(spieler.isRaus()){
		$(&quot;#&quot;+id).addClass(&quot;out&quot;);
	}
}

/**
 * Initalisiert das Spiel
 *
 * @method initGame
 * @param {JSON} data 
 */
Display.prototype.initGame = function(data){
	var i, id, color, cursor,html;
	$(&quot;#display&quot;).html(&#x27;&lt;div id=&quot;gamefield&quot;&gt;&lt;div id=&quot;gameInfos&quot;&gt;&lt;/div&gt;&lt;div id=&quot;blockfield&quot;&gt;&lt;/div&gt;&lt;div id=&quot;effektfield&quot;&gt;&lt;/div&gt;&lt;/div&gt;&#x27;);
	html = &quot;&quot;;
	html += &quot;&lt;h2&gt;&quot;+data.SpielTyp.bezeichnung+&quot; &lt;span id=&#x27;spielZeit&#x27;&gt;&lt;/span&gt;&lt;/h2&gt;&lt;ul&gt;&lt;/ul&gt;&quot;;
	html += &quot;&lt;h2&gt;Spielinfos&lt;/h2&gt;&quot;;
	html += &quot;&lt;p&gt;&lt;span&gt;SpielID&lt;/span&gt;&lt;span&gt;&amp;nbsp;&quot;+data.SpielID+&quot;&lt;/span&gt;&lt;/p&gt;&quot;;
	$(&quot;#gameInfos&quot;).html(html);
	$(window).resize();
	this.showGame();
	this._field_w = data.details.w;
	this._field_h = data.details.h;
	this.createBlockfield();
	for(i in data.details.spieler){
		id = data.details.spieler[i].id;
		color = data.details.spieler[i].color;
		cursor = data.details.spieler[i].cursor;
		this._spieler[id] = new Spieler(id);
		this._spieler[id].setColor(color);
		this._spieler[id].setCursor(cursor);
		this._spieler[id].setName(data.details.spieler[i].name);
		this._spieler[id].setPunkte(data.details.spieler[i].punkte);
		this._spieler[id].setPlatz(data.details.spieler[i].platz);
		this._spieler[id].setRaus(!data.details.spieler[i].active);
		
		this.createPlayerElement(this._spieler[id]);
		this.createPlayerInfos(this._spieler[id]);
	}
};

/**
 * @method tick
 */
Display.prototype.tick = function(){
	var i, spieler, x, y, id;
	
	for(i in this._spieler){
		spieler = this._spieler[i];
		if(!(spieler instanceof Spieler)) continue;
		
		id = &quot;cursor_&quot;+spieler.getId();
		x = spieler.getCursor()[0] * this.getBlockWidth();
		y = spieler.getCursor()[1] * this.getBlockHeight();
		$(&quot;#&quot;+id).css(&quot;left&quot;,x+&quot;px&quot;);
		
	}
};

/**
 * @method startGame
 */
Display.prototype.startGame = function(){
	this.removeAllMessage();
	this._instance = setInterval((function(){ this.tick() }.bind(this)), this._fps);
	this._audio.play(&quot;startGame&quot;);
};

/**
 * @method abortGame
 */
Display.prototype.abortGame = function(){
	clearInterval(this._instance);
};

/**
 * @method init
 */
Display.prototype.init = function(){
	
	$(window).on(&quot;resize&quot;, function(){
		this.resize();
	}.bind(this));
	
	// start connection
	this._socket = io.connect(this._serverAdress);
	
	this._afterGame.init();
	
	this._socket.on(&#x27;connect&#x27;, function () {
		this._lounge.init(this._socket);
	
		/*
		 * Zeigt Verbindungsverlust und wiederconnect an -&gt; neu laden
		 */
		if(this._connectionLost){
			$(&quot;#connection_lost&quot;).html(&quot;Connection found. Reload in &lt;span&gt;&quot;+CONFIG.reconnectReloadTime+&quot;&lt;/span&gt;ms...&quot;);
			setTimeout(&quot;window.location.reload();&quot;, CONFIG.reconnectReloadTime);
			$(&quot;#connection_lost span&quot;).prop(&#x27;number&#x27;, CONFIG.reconnectReloadTime);
			$(&quot;#connection_lost span&quot;).animateNumber({ number: 0, easing: &#x27;linear&#x27; }, CONFIG.reconnectReloadTime);
			return;
		}
	
		/*
		 * Display verbindet sich
		 */
		this._socket.emit(&#x27;connectDisplay&#x27;, {}, function (data) {
			this._id = data;
		});
		
		/*
		 * Spiel wurde gestartet
		 */
		this._socket.on(&#x27;SpielStarts&#x27;, function (data) {
			this.initGame(data);
			this.startGame();
			this.removeAllMessage();
			this._afterGame.hide();
		}.bind(this));
		
		/*
		 * Bei jeder eingabe oder Tackt.
		 */
		this._socket.on(&#x27;SpielFrame&#x27;, function (data) {
			this.computeSpielFrame(data);
		}.bind(this));
		
		/*
		 * Effekte die Angezeigt werden sollen.
		 */
		this._socket.on(&#x27;SpielEffect&#x27;, function (effect) {
			this.computeSpielEffect(effect);
		}.bind(this));
		
		/*
		 * Spiel wurde abgebrochen.
		 */
		this._socket.on(&#x27;SpielAborted&#x27;, function (data) {
			// .. void
		}.bind(this));
		
		/*
		 * Ein Spieler ist aus dem Spiel ausgeschieden.
		 */
		this._socket.on(&#x27;SpielSpielerRaus&#x27;, function (data) {
			// .. void
		}.bind(this));
		
		/*
		 * Das Spiel Endet.
		 */
		this._socket.on(&#x27;SpielEnds&#x27;, function (data) {
			this._afterGame.show(data);
		}.bind(this));
		
		/*
		 * Das Profil, welches verfolgt wird, hat sich in ein Spiel eingelogt.
		 */
		this._socket.on(&#x27;ProfilLoggedInGame&#x27;, function (data) {
			this._afterGame.hide();
			if(data.isLoggedInGame){
				this.connectToSpiel(data.SpielID);
			}else{
				$(&quot;#profil_status&quot;).text(&quot;&quot;);
				this.disconnectFromSpiel();
			}
		}.bind(this));
		
		/*
		 * Die Punkte eines Spieler hat sich während des Spiels verändert.
		 */
		this._socket.on(&#x27;SpielSpielerPunkte&#x27;, function (dataSpieler) {
		 	var spieler = this._spieler[dataSpieler.id];
		
			var id = &quot;playerInfo_&quot;+spieler.getId();
			 
			if(dataSpieler.punkte != spieler.getPunkte()){
				spieler.setPunkte(dataSpieler.punkte);
				
				$(&quot;#&quot;+id+&quot; .playerPunkte&quot;).text(dataSpieler.punkte);
				
				$(&quot;#&quot;+id+&quot; .playerPunkte&quot;).stop().css({color:&quot;#ffffff&quot;}).animate({
					color: &quot;#838d97&quot;
				}, 500);
			}
		}.bind(this));
		
		/*
		 * Das Level eines Spieler hat sich während des Spiels verändert.
		 */
		this._socket.on(&#x27;SpielSpielerLevel&#x27;, function (dataSpieler) {
		 	var spieler = this._spieler[dataSpieler.id];
			var id = &quot;playerInfo_&quot;+spieler.getId();
			
			spieler.setLevel(dataSpieler.level);
			
			$(&quot;#&quot;+id+&quot; .playerLevel&quot;).text(spieler.getLevel());
		}.bind(this));
		
		/*
		 * Die Platzierung eines Spieler hat sich während des Spiels verändert.
		 */
		this._socket.on(&#x27;SpielPlatzierung&#x27;, function (dataSpielerListe) {
			var spieler, i, dataSpieler, id, platzierungChange;
			platzierungChange=false;
			for(i in dataSpielerListe){
				dataSpieler = dataSpielerListe[i];
				spieler = this._spieler[dataSpieler.id];
				id = &quot;playerInfo_&quot;+spieler.getId();
				
				if(dataSpieler.platz != spieler.getPlatz()){
					spieler.setPlatz(dataSpieler.platz);
					$(&quot;#&quot;+id+&quot; .playerPlatz&quot;).text(dataSpieler.platz);
					
					$(&quot;#&quot;+id+&quot; .playerPlatz&quot;).stop().css({color:&quot;#ffffff&quot;}).animate({
						color: &quot;#838d97&quot;
					}, 500);
					
					platzierungChange = true;
				}
			}
		}.bind(this));
		
	}.bind(this)); 
	
	// Verbindung verloren
	this._socket.on(&#x27;disconnect&#x27;, function() {
		$(&quot;#connection_lost&quot;).html(&quot;Connection Lost.. trying to reconnect..&quot;);
		$(&quot;#connection_lost&quot;).show();
		this._connectionLost = true;
	}.bind(this)); 
	
	this.bindConnect();
	
	/* muss man nicht verstehen, wieso das 2 mal ausgeführt werden muss, damit es auch funktioniert.. */
	$(window).resize();
	$(window).resize();
};

/**
 *
 *
 * @method computeSpielFrame
 * @param {JSON} data 
 */
Display.prototype.computeSpielFrame = function(data){
	var x, y, id, value, spieler, dataSpieler, i, cursor, color, platzierungChange;
	
	platzierungChange = false;

	// Setzte Spielerdaten
	for(i in data.spieler){
		dataSpieler = data.spieler[i];
		spieler = this._spieler[dataSpieler.id];
		spieler.setCursor([dataSpieler.cursor[0], dataSpieler.cursor[1]]);
	}
	
	if(platzierungChange){
		console.log(&quot;resort&quot;); //TODO resort
	}
	
	// Setzte Spielfeld
	if(data.field !== null){
		try{
			for(y = 0; y &lt; this._field_h; y++){
				for(x = 0; x &lt; this._field_w; x++){
					id = &quot;#block_&quot;+x+&quot;_&quot;+y;
					value = data.field[y][x];
					
					if(value !== null){
						
						if(value.vorschau){		
							color = this._spieler[value.spielerId].getColor();
							color = &quot;rgb(80,80,80)&quot;;			
						}else{
							color = this._spieler[value.spielerId].getColor();
							color = &quot;rgb(&quot;+color[0]+&quot;,&quot;+color[1]+&quot;,&quot;+color[2]+&quot;)&quot;;
						}
						
						$(id).css({&quot;background-color&quot;: color});	
					}else{
						// resette
						$(id).css({&quot;background-color&quot;: &quot;&quot;});
					}
				}
			}
		}catch(err){
			alert(&quot;BOOOM&quot;);
		}
	}
	
};

/**
 * @method computeSpielEffect
 * @param {String} effect
 */
Display.prototype.computeSpielEffect = function(effect){
	var data, y, element, i, x;

	switch(effect.type){
		case &quot;spielerRaus&quot;:
			this._audio.play(&quot;spielerRaus&quot;);
		break;
		case &quot;blockSolidate&quot;:
			this._audio.play(&quot;blockSolidate&quot;);
		break;
		case &quot;blockRotate&quot;:
			this._audio.play(&quot;blockRotate&quot;);
		break;
		case &quot;SpielEnds&quot;:
			this._audio.play(&quot;SpielEnds&quot;);
		break;
		case &quot;lineKill&quot;:
			this._audio.play(&quot;lineKill&quot;);
	
			data = effect.data;
			for(i in data.line){
				y  = data.line[i];
				
				for(x = 0; x &lt; this._field_w; x++){
					element = this.createBlock(x,y);
					element.css({
						backgroundColor: &quot;rgba(255,255,255,1)&quot;
					}).animate({
						backgroundColor: &quot;rgba(255,255,255,0)&quot;,
						top: (parseInt($(element).css(&quot;top&quot;))+this.getBlockHeight())+&quot;px&quot;
					},250, function(){
						$(this).remove();
					});
					$(&quot;#effektfield&quot;).append(element);
				}
			}
		break;
		default:
			alert(&quot;Effekt unbekannnt: &quot;+ effect.type);
	}
};

/**
 * Display wird von Spiel getrennt
 *
 * @method disconnectFromSpiel
 *
 * @async
 */
Display.prototype.disconnectFromSpiel = function(){
	this.showMessage(&quot;Spiel disconnecten...&quot;);
	var id = this._spielId;
	this._socket.emit(&#x27;disconnectFromSpiel&#x27;, {SpielID: id}, function (data) {
		this._spielId = null;
		this.hideGame();
		this.removeAllMessage();
		
		if(this._spieler){
			this.showMessage(&quot;&lt;h1&gt;Verbunden&lt;/h1&gt; &lt;p&gt;Sie verfolgen das Profil von &quot;+this._spieler.Name+&quot;.&lt;/p&gt;&lt;p id=&#x27;profil_status&#x27;&gt;&lt;/p&gt;&quot;);
		}
	}.bind(this));
};

/**
 * Display verfolgt ein Spiel, anhand der übergebene ID
 *
 * @method connectToSpiel
 * @param {Number} id
 * @async
 */
Display.prototype.connectToSpiel = function(id){
	if(this.lastHash &amp;&amp; this.lastHash.indexOf(&quot;#profil/&quot;)===0){
		/* void */
	}else{
		this.lastHash = &quot;#spiel/&quot;+id;
		window.location.hash = &quot;#spiel/&quot;+id;
	}
	
	this._socket.emit(&#x27;connectToSpiel&#x27;, {SpielID: id}, function (data) {
		if(data.ok === true){
			$(&quot;#AuswahlSpielSpieler&quot;).stop().animate({
				&quot;opacity&quot;:1
			}, 250, function(){
				$(&quot;#AuswahlSpielSpieler&quot;).hide();
				$(&quot;#AuswahlSpielSpieler&quot;).stop().css(&quot;opacity&quot;, 1);
			});
			if(data.data.GameStatus === &quot;boarding&quot;){
				this._afterGame.hide();
				this._lounge.show(data.data);
			}
		}else{
			$(&quot;#AuswahlSpielSpieler_info&quot;).html(data.message);
			$(&quot;#AuswahlSpielSpieler_info&quot;).show();
			$(&quot;#AuswahlSpielSpieler_info&quot;).stop().animate({&quot;z-index&quot;:0}, 5000,
			function(){
				$(&quot;#AuswahlSpielSpieler_info&quot;).stop().hide();
			});
			this.resetConnectForm();
		}
	}.bind(this));
	
	$(&quot;#spiel_erID&quot;).val(&quot;Verbinde...&quot;);
	
	$(&quot;#AuswahlSpielSpieler #spiel_erID&quot;).prop(&quot;disabled&quot;, true);
	$(&quot;#AuswahlSpielSpieler button&quot;).prop(&quot;disabled&quot;, true);
	$(&quot;#spiel_erID&quot;).prop(&quot;readonly&quot;, true);
	$(&quot;#AuswahlSpielSpieler span&quot;).css(&quot;text-indent&quot;,&quot;-10000px&quot;);	
};

/**
 * Display verfolgt ein Profil, anhand des übergebenden Namens
 *
 * @method connectToProfilByName
 * @param {String} name
 */
Display.prototype.connectToProfilByName = function(name){
	$.getJSON( &quot;/api/profil/byname/&quot;+encodeURIComponent(name), function(data) {
		var id = data ? data.ProfilID : null; 		
		this.connectToProfil(id);
	}.bind(this));
};

/**
 * Display verfolgt ein Profil, anhand der übergebende ID
 * 
 * @method connectToProfil
 * @param {Number} id
 */
Display.prototype.connectToProfil = function(id){
	this.lastHash = &quot;#profil/&quot;+id;
	window.location.hash = &quot;#profil/&quot;+id;
	
	this._socket.emit(&#x27;connectToProfil&#x27;, {ProfilID: id}, function (data) {
		if(data.ok === true){
			$(&quot;#AuswahlSpielSpieler&quot;).stop().animate({
				&quot;opacity&quot;:1
			}, 250, function(){
				$(&quot;#AuswahlSpielSpieler&quot;).hide();
				$(&quot;#AuswahlSpielSpieler&quot;).stop().css(&quot;opacity&quot;, 1);
			});
			
			this._spieler = data.data;
			if(this._spieler.isLoggedInGame){
				this.connectToSpiel(this._spieler.SpielID);
			}else{
				this.showMessage(&quot;&lt;h1&gt;Verbunden&lt;/h1&gt; &lt;p&gt;Sie verfolgen das Profil von &quot;+data.data.Name+&quot;.&lt;/p&gt;&lt;p id=&#x27;profil_status&#x27;&gt;&lt;/p&gt;&quot;);
			}	
		}else{
			$(&quot;#AuswahlSpielSpieler_info&quot;).html(data.message);
			$(&quot;#AuswahlSpielSpieler_info&quot;).show();
			$(&quot;#AuswahlSpielSpieler_info&quot;).stop().animate(
				{ &quot;z-index&quot;: 0 }, 
				5000,
				function(){
					$(&quot;#AuswahlSpielSpieler_info&quot;).stop().hide();
				}
			);
			this.resetConnectForm();
		}
	}.bind(this));
	
	$(&quot;#spiel_erID&quot;).val(&quot;Verbinde...&quot;);
	
	$(&quot;#AuswahlSpielSpieler #spiel_erID&quot;).prop(&quot;disabled&quot;, true);
	$(&quot;#AuswahlSpielSpieler button&quot;).prop(&quot;disabled&quot;, true);
	$(&quot;#spiel_erID&quot;).prop(&quot;readonly&quot;, true);
	$(&quot;#AuswahlSpielSpieler span&quot;).css(&quot;text-indent&quot;,&quot;-10000px&quot;);
};

/**
 * Bindet Verbindung
 *
 * @method bindConnect
 */
Display.prototype.bindConnect = function(){
		
	$(&quot;#AuswahlSpielSpieler #verbinden_spiel&quot;).on(&quot;click&quot;, function(event){
		if($(&quot;#spiel_erID&quot;).val() == &quot;&quot;){$(&quot;#spiel_erID&quot;).focus();return;}
		
		this.connectToSpiel(parseInt($(&quot;#spiel_erID&quot;).val()));
	}.bind(this));
	
	$(&quot;#AuswahlSpielSpieler #verbinden_spieler&quot;).on(&quot;click&quot;, function(event){
		if($(&quot;#spiel_erID&quot;).val() == &quot;&quot;){$(&quot;#spiel_erID&quot;).focus();return;} 
		
		this.connectToProfilByName($(&quot;#spiel_erID&quot;).val());
	}.bind(this));
	
	$(&quot;#AuswahlSpielSpieler&quot;).on(&quot;submit&quot;, function(event){
		var value = $(&quot;#spiel_erID&quot;).val();
		if($.isNumeric(value)){
			$(&quot;#AuswahlSpielSpieler #verbinden_spiel&quot;).click();
		}else{
			$(&quot;#AuswahlSpielSpieler #verbinden_spieler&quot;).click();
		}
	});
};

/**
 * Setzt das Verbindung Formular zurück
 *
 * @method resetConnectForm
 */
Display.prototype.resetConnectForm = function(){
	$(&quot;#spiel_erID&quot;).val(&quot;&quot;);
	$(&quot;#AuswahlSpielSpieler button&quot;).prop(&quot;disabled&quot;, false);
	$(&quot;#AuswahlSpielSpieler #spiel_erID&quot;).prop(&quot;disabled&quot;, false);
	$(&quot;#spiel_erID&quot;).prop(&quot;readonly&quot;, false); 
	$(&quot;#AuswahlSpielSpieler span&quot;).css(&quot;text-indent&quot;,&quot;0px&quot;);
	$(&quot;#spiel_erID&quot;).focus();
};

/**
 * @method showGame
 */
Display.prototype.showGame = function(){
	$(&quot;#display&quot;).show();
	this._afterGame.hide();
	$(&quot;#AuswahlSpielSpieler&quot;).hide();
};

/**
 * @method hideAll
 */
Display.prototype.hideAll = function(){
	$(&quot;#display&quot;).hide();
	$(&quot;#AuswahlSpielSpieler&quot;).hide();
	this._afterGame.hide();
};

/**
 * @method hideGame
 */
Display.prototype.hideGame = function(){
	$(&quot;#display&quot;).hide();
};

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
